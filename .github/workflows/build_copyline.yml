name: build_copyline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 * * *"  # ежедневно 03:00 Алматы (UTC+6)

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COPYLINE_XLSX_URL: ${{ secrets.COPYLINE_XLSX_URL }}
      COPYLINE_BASIC_USER: ${{ secrets.COPYLINE_BASIC_USER }}
      COPYLINE_BASIC_PASS: ${{ secrets.COPYLINE_BASIC_PASS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure docs folder & nojekyll
        run: |
          mkdir -p docs
          printf "" > docs/.nojekyll

      - name: Download Copyline price (copyline.xlsx)
        shell: bash
        run: |
          set -eo pipefail
          if [ -z "$COPYLINE_XLSX_URL" ]; then
            echo "ERROR: secrets.COPYLINE_XLSX_URL не задан." >&2
            exit 1
          fi
          if [ -n "$COPYLINE_BASIC_USER" ] && [ -n "$COPYLINE_BASIC_PASS" ]; then
            curl -L --fail --retry 5 -u "$COPYLINE_BASIC_USER:$COPYLINE_BASIC_PASS" "$COPYLINE_XLSX_URL" -o docs/copyline.xlsx
          else
            curl -L --fail --retry 5 "$COPYLINE_XLSX_URL" -o docs/copyline.xlsx
          fi
          ls -lh docs/copyline.xlsx

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build copyline.yml
        run: |
          set -eo pipefail
          python scripts/build_copyline.py
          test -s docs/copyline.yml || (echo "ERROR: docs/copyline.yml пустой" >&2; exit 1)

      - name: Commit copyline.yml
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "build: copyline.yml"
          file_pattern: |
            docs/copyline.yml
            docs/.nojekyll
