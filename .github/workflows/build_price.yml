name: build_price

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"   # 06:00 Asia/Almaty (UTC+5)

concurrency:
  group: build_price_${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Almaty schedule gate
        id: gate
        run: |
          python - <<'PY'
          from datetime import datetime, timedelta
          import os
          now_utc = datetime.utcnow()
          now_alm = now_utc + timedelta(hours=5)  # Asia/Almaty ~ UTC+5
          should = 'yes' if now_alm.hour == 6 else 'no'
          print(f"::notice::Almaty now: {now_alm:%Y-%m-%d %H:%M:%S}, should_run={should}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"run={should}\n")
          PY

      - uses: actions/setup-python@v5
        if: ${{ github.event_name == 'workflow_dispatch' || steps.gate.outputs.run == 'yes' }}
        with:
          python-version: "3.11"

      - name: Build merged Price.yml
        if: ${{ github.event_name == 'workflow_dispatch' || steps.gate.outputs.run == 'yes' }}
        run: |
          set -e
          python scripts/build_price.py

      - name: Commit & push Price.yml
        if: ${{ github.event_name == 'workflow_dispatch' || steps.gate.outputs.run == 'yes' }}
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/price.yml docs/.nojekyll || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(price): merge supplier feeds into docs/price.yml"
            git pull --rebase origin "$BRANCH_NAME" || true
            git push origin "$BRANCH_NAME"
          fi

      - name: Print useful URLs (Pages + RAW/CDN)
        if: ${{ github.event_name == 'workflow_dispatch' || steps.gate.outputs.run == 'yes' }}
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_SLUG: ${{ github.repository }}
        run: |
          set -e
          REPO="${REPO_SLUG#*/}"  # extract repo name from owner/repo
          PAGES="https://${OWNER}.github.io/${REPO}/price.yml"
          RAW="https://raw.githubusercontent.com/${OWNER}/${REPO}/main/docs/price.yml"
          CDN1="https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@main/docs/price.yml"
          CDN2="https://cdn.statically.io/gh/${OWNER}/${REPO}/main/docs/price.yml"

          echo "::notice::PAGES: ${PAGES}"
          echo "::notice::RAW:   ${RAW}"
          echo "::notice::CDN1:  ${CDN1}"
          echo "::notice::CDN2:  ${CDN2}"

          echo "PAGES: ${PAGES}"
          echo "RAW:   ${RAW}"
          echo "CDN1:  ${CDN1}"
          echo "CDN2:  ${CDN2}"
