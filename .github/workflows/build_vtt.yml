import re
from bs4 import BeautifulSoup

def _txt(el):
    return (el.get_text(" ", strip=True) if el else "").strip()

def extract_sku(soup: BeautifulSoup) -> str | None:
    # <dt>Артикул:</dt><dd>XXXX</dd>
    for dt in soup.select("dt"):
        if "артикул" in _txt(dt).lower():
            dd = dt.find_next_sibling("dd")
            val = _txt(dd)
            if val:
                return val
    # запасной вариант: взять из спана списка (если он есть в карточке)
    art = soup.select_one("span.artnum")
    if art and _txt(art):
        return _txt(art)
    return None

def extract_price_currency(soup: BeautifulSoup) -> tuple[float | None, str | None]:
    # основной блок цены на карточке
    price_wrap = soup.select_one("span.price_main") or soup.select_one("span.price")
    if not price_wrap:
        return None, None
    val_el = price_wrap.find("b") or price_wrap
    cur_el = price_wrap.find("ins")
    raw = _txt(val_el)
    cur = _txt(cur_el).replace(".", "").strip() if cur_el else ""
    # нормализуем валюту
    if cur in ("₸", "Т", "T"): currency = "KZT"
    elif cur in ("₽", "руб", "руб.", "RUB"): currency = "RUB"
    else: currency = None
    # число
    num = None
    if raw:
        raw = raw.replace("\xa0", " ").replace(" ", "").replace(",", ".")
        m = re.search(r"\d+(?:\.\d+)?", raw)
        if m:
            num = float(m.group(0))
    return num, currency

def extract_title(soup: BeautifulSoup) -> str:
    h1 = soup.select_one("h1")
    return _txt(h1)
