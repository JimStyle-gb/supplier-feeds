name: build_akcent

on:
  workflow_dispatch:
  schedule:
    # 01:00 Asia/Almaty (UTC+5) = 20:00 UTC предыдущего дня
    - cron: "0 20 * * *"
  push:
    paths:
      - ".github/workflows/build_akcent.yml"
      - "scripts/build_akcent.py"
      - "docs/akcent_keywords.txt"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install "requests>=2.31,<3"

      - name: Verify keywords file exists and not empty
        run: |
          if [ ! -s docs/akcent_keywords.txt ]; then
            echo "::error file=docs/akcent_keywords.txt::Файл docs/akcent_keywords.txt отсутствует или пуст."
            exit 1
          fi
          echo "---- docs/akcent_keywords.txt (первые строки) ----"
          nl -ba docs/akcent_keywords.txt | sed -n '1,40p'

      - name: Build feed
        env:
          SUPPLIER_NAME: akcent
          OUT_FILE: docs/akcent.yml
          OUTPUT_ENCODING: windows-1251
          CATEGORIES_FILE: docs/akcent_keywords.txt
          TIMEOUT_S: "30"
          RETRIES: "4"
          RETRY_BACKOFF_S: "2"
          MIN_BYTES: "1500"
          # BASIC_USER/BASIC_PASS можно оставить пустыми; если поставщик требует — добавь их как secrets
          BASIC_USER: ${{ secrets.AKCENT_USER }}
          BASIC_PASS: ${{ secrets.AKCENT_PASS }}
          VENDORCODE_PREFIX: "AC"
        run: |
          python scripts/build_akcent.py

      - name: Duplicate YML as XML (for picky importers)
        run: |
          cp docs/akcent.yml docs/akcent.xml

      - name: Ensure GitHub Pages compatibility
        run: |
          mkdir -p docs
          touch docs/.nojekyll

      - name: Commit & push changes
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain -- docs/akcent.yml docs/akcent.xml docs/.nojekyll)" ]; then
            git add docs/akcent.yml docs/akcent.xml docs/.nojekyll
            git commit -m "build: update akcent.{yml,xml}"
            git push
          else
            echo "No changes to commit."
          fi
