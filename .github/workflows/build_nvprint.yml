# .github/workflows/build_nvprint.yml
name: build_nvprint

on:
  workflow_dispatch:

concurrency:
  group: build_nvprint_${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Ensure keywords file
        run: |
          mkdir -p docs
          if [ ! -f docs/nvprint_keywords.txt ]; then
            cat > docs/nvprint_keywords.txt <<'TXT'
Картридж
Тонер-картридж
Тонер-туба
Блок фотобарабана
Фотобарабан
Струйный картридж
Печатающая головка
TXT
          fi
          echo "==== nvprint_keywords.txt ===="
          cat docs/nvprint_keywords.txt

      - name: Build YML
        env:
          NVPRINT_XML_URL: ${{ secrets.NVPRINT_XML_URL }} # или зашить URL прямо в секрет
          NVPRINT_LOGIN: ${{ secrets.NVPRINT_LOGIN }}
          NVPRINT_PASSWORD: ${{ secrets.NVPRINT_PASSWORD }}

          OUT_FILE: docs/nvprint.yml
          OUTPUT_ENCODING: windows-1251
          TIMEOUT_S: "45"
          RETRIES: "4"
          RETRY_BACKOFF_S: "2.0"
          MIN_BYTES: "1500"

          NVPRINT_KEYWORDS_PATH: docs/nvprint_keywords.txt
          NVPRINT_FORCE_AVAILABLE: "0"         # если нужно все=true → поставь 1

          VENDORCODE_PREFIX: "NP"              # наш префикс
          NVPRINT_SUPPLIER_PREFIX: "NV-"       # отрезаем этот префикс у поставщика
        run: |
          python scripts/build_nvprint.py

      - name: Commit & push
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/nvprint.yml
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore(nvprint): update docs/nvprint.yml [skip ci]"
          git pull --rebase origin "$BRANCH_NAME" || git pull --no-rebase -X ours origin "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
