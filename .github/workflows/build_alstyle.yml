name: build_alstyle

on:
  workflow_dispatch:
  schedule:
    # 01:00 Asia/Almaty (UTC+5) = 20:00 UTC предыдущего дня
    - cron: "0 20 * * *"
  push:
    paths:
      - ".github/workflows/build_alstyle.yml"
      - "scripts/build_alstyle.py"
      - "docs/categories_alstyle.txt"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests>=2.31,<3

      - name: Verify categories file exists and not empty
        run: |
          if [ ! -s docs/categories_alstyle.txt ]; then
            echo "::error file=docs/categories_alstyle.txt::Файл docs/categories_alstyle.txt отсутствует или пуст."
            exit 1
          fi
          echo "---- docs/categories_alstyle.txt (первые строки) ----"
          nl -ba docs/categories_alstyle.txt | sed -n '1,40p'

      - name: Build feed
        env:
          SUPPLIER_URL: https://al-style.kz/upload/catalog_export/al_style_catalog.php
          OUT_FILE: docs/alstyle.yml
          OUTPUT_ENCODING: windows-1251
          CATEGORIES_FILE: docs/categories_alstyle.txt
          TIMEOUT_S: "30"
          RETRIES: "4"
          RETRY_BACKOFF_S: "2"
          MIN_BYTES: "1500"
          BASIC_USER: ${{ secrets.ALS_USER }}
          BASIC_PASS: ${{ secrets.ALS_PASS }}
        run: |
          python scripts/build_alstyle.py

      - name: Ensure GitHub Pages compatibility
        run: |
          mkdir -p docs
          touch docs/.nojekyll

      - name: Commit & push changes
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain -- docs/alstyle.yml docs/.nojekyll)" ]; then
            git add docs/alstyle.yml docs/.nojekyll
            git commit -m "build: update alstyle.yml"
            git push
          else
            echo "No changes to commit."
          fi
